pipeline {
    agent none
    stages {
        stage('Prepare report') {
            agent any
            steps {
                sh 'mkdir -p build'
                sh 'printf "Compiler\tModel\tTF\tQuantization\tBFloat16\tCorrect/Total\tResult\n" > build/accuracy.csv'
                stash includes: 'build/accuracy.csv', name: 'accuracy'

                sh 'printf "Compiler\tApp\tTF\tQuantization\tBFloat16\tAverage Time\n" > build/benchmark.csv'
                stash includes: 'build/benchmark.csv', name: 'benchmark'
            }
        }
        stage('BuildAndTest') {
            matrix {
                axes {
                    axis {
                        name 'TF_VERSION'
                        values '1.15.4', '2.5.2', '2.6.2'
                    }
                    axis {
                        name 'CXX_COMPILER'
                        values 'icpc', 'g++', 'icpx'
                    }
                    axis {
                        name 'QUANTIZATION'
                        values '--quantization', '--no-quantization'
                    }
                    axis {
                        name 'BFLOAT16'
                        values '--bfloat16', '--no-bfloat16'
                    }
                }
                // WC1-1081: icpc fails to compile TF >= 2.6.0
                excludes {
                    exclude {
                        axis {
                            name 'TF_VERSION'
                            values '2.6.2'
                        }
                        axis {
                            name 'CXX_COMPILER'
                            values 'icpc'
                        }
                    }
                    exclude {
                        axis {
                            name 'BFLOAT16'
                            values '--bfloat16'
                        }
                    }
                }
                agent {
                    dockerfile {
                        filename 'Dockerfile/Dockerfile-ci'
                        label 'JenkinsServer'
                        additionalBuildArgs  '--build-arg TF_VERSION=${TF_VERSION} --no-cache'
                        // TODO: WC1-1063 using of more cpus causes the accuracy script to hang or segfault
                        args '--cpuset-cpus="0-10" --init \
                            -v ${jenkins_data}:/data'
                    }
                }
                environment {
                    TFDS_DATA_DIR = '/data/tfds_data'
                }
                stages {
                    stage('build') {
                        steps {
                            // TODO: use virtualenv?
                            sh '${Python3_EXECUTABLE} -m pip install -r requirements-tf${TF_VERSION%%.*}.txt'
                            dir('build') {
                                sh 'rm -rf CMakeCache.txt CMakeFiles accuracy.csv acc.html benchmark.csv bench.html'
                                sh '''#!/bin/bash
                                    source /opt/intel/oneapi/setvars.sh intel64

                                    cmake --no-warn-unused-cli -DPython3_EXECUTABLE:FILEPATH=${Python3_EXECUTABLE} -DCMAKE_C_COMPILER=icc -DCMAKE_CXX_COMPILER=${CXX_COMPILER} -DCMAKE_BUILD_TYPE:STRING=Release -G "Unix Makefiles" ..
                                    cmake --build . --config Debug --target clean -v -j --
                                    cmake --build . --config Debug --target all -v -j --
                                '''
                            }
                            sh '''#!/bin/bash
                                ./python/proto/compile_proto.sh
                            '''
                        }
                    }
                    stage('benchmark') {
                        steps {
                            unstash 'benchmark'
                            script {
                                for(a in [10, 1000]) {
                                    sh '''#!/bin/bash
                                        source /opt/intel/oneapi/setvars.sh intel64
                                        ./build/tests/benchmark/benchmark $a | tee build/benchmark.log
                                    '''
                                    sh "grep 'Average Time' build/benchmark.log | sed 's/.*Time: \\(.*\\)/${CXX_COMPILER}\\tbenchmark.exe $a\\t${TF_VERSION}\\t${QUANTIZATION}\\t${BFLOAT16}\\t\\1/' >> build/benchmark.csv"
                                }
                            }
                            stash includes: 'build/benchmark.csv', name: 'benchmark'
                        }
                    }            
                    stage('accuracy'){
                        steps {
                            unstash 'accuracy'
                            sh '''#!/bin/bash
                                export TF_VERSION=${TF_VERSION}
                                export TF_MAJOR=${TF_VERSION%%.*}
                                export CXX_COMPILER=${CXX_COMPILER}
                                export QUANTIZATION=${QUANTIZATION}
                                export BFLOAT16=${BFLOAT16}
                                export path_to_bertop=$(pwd)/build/src/tf_op/libBertOp.so   # accuracy_launcher.sh will pushd 
                                export out_file=$(pwd)/build/accuracy.csv                   # to its directory so use absolute
                                base_dir=/data/tf${TF_MAJOR}                                # paths to external resources
                                export Python3_EXECUTABLE=${Python3_EXECUTABLE}
                                export PYTHONPATH=${PYTHONPATH}:$(pwd)/python               # Need model modifier on PYTHONPATH

                                source /opt/intel/oneapi/setvars.sh intel64
                                tests/tf${TF_MAJOR}_ops_accuracy/accuracy_launcher.sh ${base_dir}
                            '''
                            stash includes: 'build/accuracy.csv', name: 'accuracy'
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            node(null) {
                unstash 'accuracy'
                sh "${Python3_EXECUTABLE} -c \"import pandas as pd; pd.read_csv('build/accuracy.csv', sep='\\t', header=None).to_html('acc.html', index=False, header=False)\""
                archiveArtifacts artifacts: "acc.html"
                sh "cat build/accuracy.csv"
                step([$class: 'ACIPluginPublisher', name: 'acc.html', shownOnProjectPage: true])

                unstash 'benchmark'
                sh "${Python3_EXECUTABLE} -c \"import pandas as pd; pd.read_csv('build/benchmark.csv', sep='\\t', header=None).to_html('bench.html', index=False, header=False)\""
                archiveArtifacts artifacts: "bench.html"
                step([$class: 'ACIPluginPublisher', name: 'bench.html', shownOnProjectPage: true])
            }
        }
    }
}
